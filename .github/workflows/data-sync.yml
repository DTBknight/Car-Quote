name: Data Sync Task

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨0ç‚¹ (UTCæ—¶é—´)
    - cron: '0 0 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    concurrency:
      group: data-sync
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      actions: write
      checks: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: data-processor/package-lock.json
        
    - name: Install Chrome Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg2 jq
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: Install Dependencies
      run: |
        cd data-processor
        npm ci
        
    - name: Execute Data Sync
      run: |
        cd data-processor
        # ä½¿ç”¨æœ€æ–°çš„é‡‡é›†å·¥å…·è¿›è¡Œæ•°æ®åŒæ­¥
        echo "ðŸš€ å¼€å§‹æ‰§è¡Œæ•°æ®åŒæ­¥ä»»åŠ¡..."
        echo "ðŸ“… æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ðŸ”§ ä½¿ç”¨å·¥å…·: index-sync.js (åŸºäºŽå¢žå¼ºç‰ˆé‡‡é›†å·¥å…·)"
        
        # æ‰§è¡Œæ•°æ®åŒæ­¥
        node index-sync.js
        
        echo "âœ… æ•°æ®åŒæ­¥ä»»åŠ¡å®Œæˆ"
      env:
        # Set environment variables
        NODE_ENV: production
        PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
        PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable
      timeout-minutes: 300
        
    - name: Validate Data Integrity
      run: |
        set -e
        cd data-processor
        echo "ðŸ” éªŒè¯æ•°æ®å®Œæ•´æ€§..."
        
        # éªŒè¯é‡‡é›†å·¥å…·é…ç½®
        echo "ðŸ“‹ æ£€æŸ¥é‡‡é›†å·¥å…·é…ç½®..."
        if [ -f "config.js" ]; then
          echo "âœ… é‡‡é›†å·¥å…·é…ç½®æ–‡ä»¶å­˜åœ¨"
          echo "   - è¶…æ—¶è®¾ç½®: $(grep -o 'timeout: [0-9]*' config.js || echo 'é»˜è®¤å€¼')"
          echo "   - é¡µé¢ç­‰å¾…æ—¶é—´: $(grep -o 'pageWaitTime: [0-9]*' config.js || echo 'é»˜è®¤å€¼')"
        else
          echo "âŒ é‡‡é›†å·¥å…·é…ç½®æ–‡ä»¶ç¼ºå¤±"
        fi
        
        # éªŒè¯æ•°æ®æ–‡ä»¶
        echo "ðŸ“Š éªŒè¯æ•°æ®æ–‡ä»¶..."
        node scripts/validate.js
        
        echo "âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯å®Œæˆ"
        
    - name: Generate Summary
      run: |
        set -e
        cd data-processor
        
        echo "## ðŸš€ æ•°æ®åŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        
        # æ˜¾ç¤ºé‡‡é›†å·¥å…·ç‰ˆæœ¬ä¿¡æ¯
        echo "## ðŸ”§ é‡‡é›†å·¥å…·ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- å·¥å…·ç‰ˆæœ¬: å¢žå¼ºç‰ˆ v2.0" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸»è¦åŠŸèƒ½:" >> $GITHUB_STEP_SUMMARY
        echo "  - å®žæ—¶æ•°æ®é‡‡é›†æ—¥å¿—æ˜¾ç¤º" >> $GITHUB_STEP_SUMMARY
        echo "  - æ™ºèƒ½ä»·æ ¼æå–ï¼ˆè¿‡æ»¤è¯¢åº•ä»·ç­‰é¢å¤–æ–‡å­—ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "  - å‚æ•°é…ç½®é¡µé¢è‡ªåŠ¨é‡‡é›†" >> $GITHUB_STEP_SUMMARY
        echo "  - å¤–è§‚/å†…é¥°å›¾ç‰‡åˆ†ç±»é‡‡é›†" >> $GITHUB_STEP_SUMMARY
        echo "  - å¤šè‰²å—æ”¯æŒï¼ˆå•è‰²ã€åŒè‰²ã€å¤šè‰²æ¸å˜ï¼‰" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "weekly-execution.log" ]; then
          echo "## ðŸ“Š æ‰§è¡Œè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- æ—¥å¿—æ–‡ä»¶: weekly-execution.log" >> $GITHUB_STEP_SUMMARY
          
          # æŸ¥æ‰¾æœ€æ–°çš„æŠ¥å‘Šæ–‡ä»¶
          latest_report=$(ls -t weekly-report-*.json 2>/dev/null | head -1)
          if [ -n "$latest_report" ]; then
            echo "- æ‰§è¡ŒæŠ¥å‘Š: $latest_report" >> $GITHUB_STEP_SUMMARY
            success_rate=$(jq -r '.successRate' "$latest_report" 2>/dev/null || echo "N/A")
            echo "- æˆåŠŸçŽ‡: $success_rate" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## âŒ æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰§è¡Œå¤±è´¥: æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Commit Updates
      run: |
        set -e
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        echo "Adding data files..."
        git add data/*.json || true
        echo "Adding weekly logs and reports..."
        git add -f data-processor/weekly-execution.log data-processor/weekly-report-*.json data-processor/weekly-progress.json || true
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ“Š Data sync update - $(date '+%Y-%m-%d')"
          git pull origin main --rebase --autostash
          git push origin HEAD:main
        fi