name: Data Sync Task

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨æ‰§è¡Œé€‰é¡¹ï¼š
    # 1. æ¯å‘¨ä¸€å‡Œæ™¨0ç‚¹ (UTCæ—¶é—´ï¼Œå³åŒ—äº¬æ—¶é—´ä¸Šåˆ8ç‚¹)
    # 2. æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ (UTCæ—¶é—´ï¼Œå³åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹) 
    # 3. æ¯å‘¨ä¸€å‡Œæ™¨6ç‚¹ (UTCæ—¶é—´ï¼Œå³åŒ—äº¬æ—¶é—´ä¸‹åˆ2ç‚¹)
    # å½“å‰è®¾ç½®ï¼šæ¯å‘¨ä¸€å‡Œæ™¨0ç‚¹ (UTCæ—¶é—´)
    - cron: '0 0 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: data-processor/package-lock.json
        
    - name: Install Chrome Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg2
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: Install Dependencies
      run: |
        cd data-processor
        npm ci
        
    - name: Execute Data Sync
      run: |
        cd data-processor
        node index-sync.js
      env:
        # Set environment variables
        NODE_ENV: production
        PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
        
    - name: Validate Data Integrity
      run: |
        cd data-processor
        node scripts/validate.js
        
    - name: Generate Summary
      run: |
        cd data-processor
        if [ -f "weekly-execution.log" ]; then
          echo "## æ•°æ®åŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- æ—¥å¿—æ–‡ä»¶: weekly-execution.log" >> $GITHUB_STEP_SUMMARY
          
          # æŸ¥æ‰¾æœ€æ–°çš„æŠ¥å‘Šæ–‡ä»¶
          latest_report=$(ls -t weekly-report-*.json 2>/dev/null | head -1)
          if [ -n "$latest_report" ]; then
            echo "- æ‰§è¡ŒæŠ¥å‘Š: $latest_report" >> $GITHUB_STEP_SUMMARY
            success_rate=$(jq -r '.successRate' "$latest_report" 2>/dev/null || echo "N/A")
            echo "- æˆåŠŸçŽ‡: $success_rate" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## æ•°æ®åŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰§è¡Œå¤±è´¥: æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Commit Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        echo "Checking file status..."
        git status --porcelain
        echo "Adding data files..."
        git add data/*.json
        echo "Adding weekly logs and reports..."
        git add -f data-processor/weekly-execution.log data-processor/weekly-report-*.json data-processor/weekly-progress.json
        echo "Checking for changes..."
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          echo "Committing changes..."
          git commit -m "ðŸ“Š Data sync update - $(date '+%Y-%m-%d')"
          echo "Pushing to remote repository..."
          git push
        fi 