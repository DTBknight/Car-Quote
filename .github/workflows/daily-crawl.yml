name: æ¯æ—¥æ–°è½¦é‡‡é›†

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹æ‰§è¡Œ
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  daily-crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        cd data-processor
        npm install puppeteer
        
    - name: è¿è¡Œæ¯æ—¥é‡‡é›†
      run: |
        cd data-processor
        node daily-crawler.js
        
    - name: æ£€æŸ¥å˜æ›´
      id: check-changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has-changes=true" >> $GITHUB_OUTPUT
        else
          echo "has-changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: æäº¤å˜æ›´
      if: steps.check-changes.outputs.has-changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/
        git add data-processor/daily-report-*.json
        git commit -m "ğŸ”„ æ¯æ—¥æ–°è½¦é‡‡é›†æ›´æ–° $(date '+%Y-%m-%d')"
        git push
        
    - name: åˆ›å»ºIssueæŠ¥å‘Š
      if: steps.check-changes.outputs.has-changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è¯»å–æœ€æ–°çš„æŠ¥å‘Šæ–‡ä»¶
          const reportFiles = fs.readdirSync('data-processor')
            .filter(file => file.startsWith('daily-report-'))
            .sort()
            .reverse();
            
          if (reportFiles.length === 0) {
            console.log('æœªæ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶');
            return;
          }
          
          const reportPath = path.join('data-processor', reportFiles[0]);
          const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
          
          // ç”ŸæˆIssueå†…å®¹
          let issueBody = `# ğŸ“Š æ¯æ—¥æ–°è½¦é‡‡é›†æŠ¥å‘Š - ${report.timestamp.split('T')[0]}\n\n`;
          
          issueBody += `## ğŸ“ˆ é‡‡é›†ç»Ÿè®¡\n`;
          issueBody += `- ğŸ†• æ–°è½¦å‹: ${report.summary.newCars}\n`;
          issueBody += `- ğŸ“ æ›´æ–°è½¦å‹: ${report.summary.updatedCars}\n`;
          issueBody += `- âŒ é”™è¯¯: ${report.summary.errors}\n\n`;
          
          if (report.newCars.length > 0) {
            issueBody += `## ğŸ†• æ–°è½¦å‹åˆ—è¡¨\n`;
            report.newCars.forEach(car => {
              issueBody += `- **${car.name}** (ID: ${car.carId}) - å“ç‰Œ: ${car.brand}\n`;
            });
            issueBody += '\n';
          }
          
          if (report.updatedCars.length > 0) {
            issueBody += `## ğŸ“ æ›´æ–°è½¦å‹åˆ—è¡¨\n`;
            report.updatedCars.forEach(car => {
              issueBody += `- **${car.name}** (ID: ${car.carId}) - å“ç‰Œ: ${car.brand}\n`;
            });
            issueBody += '\n';
          }
          
          if (report.errors.length > 0) {
            issueBody += `## âŒ é”™è¯¯ä¿¡æ¯\n`;
            report.errors.forEach(error => {
              issueBody += `- ${error.type}: ${error.message}\n`;
            });
            issueBody += '\n';
          }
          
          issueBody += `---\n`;
          issueBody += `*æ­¤æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*`;
          
          // åˆ›å»ºIssue
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“Š æ¯æ—¥æ–°è½¦é‡‡é›†æŠ¥å‘Š - ${report.timestamp.split('T')[0]}`,
            body: issueBody,
            labels: ['automated', 'daily-report']
          });
          
          console.log(`å·²åˆ›å»ºIssue: ${issue.data.html_url}`);
